<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Step 5 Real-Time Game Features Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #1a1a1a; color: #fff; }
        .container { max-width: 1200px; margin: 0 auto; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #333; border-radius: 8px; background: #2a2a2a; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .connected { background: #2d5a3d; border: 1px solid #4caf50; }
        .disconnected { background: #5a2d2d; border: 1px solid #f44336; }
        .event { padding: 8px; margin: 5px 0; background: #333; border-radius: 4px; font-size: 0.9em; }
        .score-event { border-left: 4px solid #ff6b35; }
        .tackle-event { border-left: 4px solid #4caf50; }
        .pass-event { border-left: 4px solid #2196f3; }
        .block-event { border-left: 4px solid #ff9800; }
        button { padding: 10px 15px; margin: 5px; background: #4caf50; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #45a049; }
        button:disabled { background: #666; cursor: not-allowed; }
        .match-info { display: grid; grid-template-columns: 1fr auto 1fr; gap: 20px; align-items: center; }
        .team { text-align: center; }
        .score { font-size: 2em; font-weight: bold; color: #ff6b35; }
        .team-name { font-size: 1.2em; margin-bottom: 10px; }
        .vs { text-align: center; font-size: 1.5em; color: #888; }
        .game-time { text-align: center; font-size: 1.1em; color: #4caf50; }
        .race-info { font-size: 0.8em; color: #888; margin-top: 5px; }
        .formation { margin-top: 10px; }
        .player { font-size: 0.7em; color: #bbb; margin: 2px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üèüÔ∏è Step 5: Real-Time Realm Rivalry Game Features Test</h1>
        
        <!-- Connection Status -->
        <div class="section">
            <h3>WebSocket Connection</h3>
            <div id="connectionStatus" class="status disconnected">
                <strong>Status:</strong> <span id="statusText">Disconnected</span>
            </div>
            <button onclick="connect()">Connect</button>
            <button onclick="disconnect()">Disconnect</button>
            <button onclick="authenticate()">Authenticate</button>
        </div>

        <!-- Match Info -->
        <div class="section">
            <h3>Live Match State</h3>
            <div class="match-info">
                <div class="team">
                    <div class="team-name">Home Team</div>
                    <div class="score" id="homeScore">0</div>
                    <div class="race-info">Mixed Fantasy Races</div>
                    <div class="formation" id="homeFormation">
                        <div class="player">Passer: Human</div>
                        <div class="player">Runners: Sylvan, Gryll</div>
                        <div class="player">Blockers: Lumina, Umbra</div>
                    </div>
                </div>
                <div class="vs">
                    <div>VS</div>
                    <div class="game-time" id="gameTime">00:00 / 30:00</div>
                    <div style="font-size: 0.8em; color: #888;" id="matchType">Exhibition Match</div>
                </div>
                <div class="team">
                    <div class="team-name">Away Team</div>
                    <div class="score" id="awayScore">0</div>
                    <div class="race-info">Mixed Fantasy Races</div>
                    <div class="formation" id="awayFormation">
                        <div class="player">Passer: Gryll</div>
                        <div class="player">Runners: Lumina, Umbra</div>
                        <div class="player">Blockers: Sylvan, Human</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Match Controls -->
        <div class="section">
            <h3>Match Controls</h3>
            <button onclick="joinMatch()">Join Match Room</button>
            <button onclick="startMatch()">Start Match</button>
            <button onclick="pauseMatch()">Pause</button>
            <button onclick="resumeMatch()">Resume</button>
            <div style="margin-top: 10px;">
                <label>
                    <input type="checkbox" id="exhibitionMode"> Exhibition Mode (30min)
                </label>
            </div>
        </div>

        <!-- Game Events -->
        <div class="section">
            <h3>Live Game Events</h3>
            <div id="events" style="max-height: 300px; overflow-y: auto;">
                <!-- Events will appear here -->
            </div>
            <button onclick="clearEvents()">Clear Events</button>
        </div>

        <!-- Real-Time Status -->
        <div class="section">
            <h3>Server Status</h3>
            <div id="serverStatus">
                <button onclick="checkServerStatus()">Check Status</button>
                <div id="statusInfo" style="margin-top: 10px;"></div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        let socket = null;
        let isConnected = false;
        let matchId = 'test-match-' + Date.now();
        let userId = 'test-user-' + Math.floor(Math.random() * 1000);

        function updateConnectionStatus(connected) {
            isConnected = connected;
            const statusDiv = document.getElementById('connectionStatus');
            const statusText = document.getElementById('statusText');
            
            if (connected) {
                statusDiv.className = 'status connected';
                statusText.textContent = 'Connected to Real-Time Game Server';
            } else {
                statusDiv.className = 'status disconnected';
                statusText.textContent = 'Disconnected';
            }
        }

        function connect() {
            if (socket) {
                socket.disconnect();
            }

            // Connect to the real-time game WebSocket
            socket = io('/', {
                path: '/socket.io/',
                transports: ['websocket', 'polling']
            });

            socket.on('connect', () => {
                console.log('Connected to real-time game server');
                updateConnectionStatus(true);
                addEvent('system', 'Connected to Realm Rivalry real-time server');
            });

            socket.on('disconnect', () => {
                console.log('Disconnected from server');
                updateConnectionStatus(false);
                addEvent('system', 'Disconnected from server');
            });

            socket.on('authenticated', (data) => {
                console.log('Authenticated:', data);
                addEvent('system', `Authenticated as user ${data.userId}`);
            });

            socket.on('match-state', (data) => {
                console.log('Match state received:', data);
                updateMatchState(data.state);
                addEvent('system', `Joined match room (${data.roomSize} users watching)`);
            });

            socket.on('match-started', (data) => {
                console.log('Match started:', data);
                addEvent('system', 'Match simulation started!');
                updateMatchState(data.state);
            });

            socket.on('match-event', (data) => {
                console.log('Match event:', data);
                addEvent(data.event.type, data.event.description, data.event);
                if (data.currentState) {
                    updateMatchState(data.currentState);
                }
            });

            socket.on('match-update', (data) => {
                console.log('Match update:', data);
                updateMatchState(data.state);
            });

            socket.on('match-completed', (data) => {
                console.log('Match completed:', data);
                addEvent('system', 'Match completed!');
                updateMatchState(data.finalState);
            });

            socket.on('match-paused', (data) => {
                addEvent('system', 'Match paused');
            });

            socket.on('match-resumed', (data) => {
                addEvent('system', 'Match resumed');
            });

            socket.on('error', (error) => {
                console.error('Socket error:', error);
                addEvent('error', error.message || 'Unknown error');
            });

            socket.on('heartbeat-response', (data) => {
                const latency = Date.now() - data.latency;
                console.log(`Heartbeat: ${latency}ms`);
            });
        }

        function disconnect() {
            if (socket) {
                socket.disconnect();
                socket = null;
            }
            updateConnectionStatus(false);
        }

        function authenticate() {
            if (!socket || !isConnected) {
                addEvent('error', 'Not connected to server');
                return;
            }
            
            socket.emit('authenticate', { userId: userId });
        }

        function joinMatch() {
            if (!socket || !isConnected) {
                addEvent('error', 'Not connected to server');
                return;
            }
            
            socket.emit('join-match', { 
                matchId: matchId, 
                userId: userId 
            });
        }

        function startMatch() {
            if (!socket || !isConnected) {
                addEvent('error', 'Not connected to server');
                return;
            }
            
            const isExhibition = document.getElementById('exhibitionMode').checked;
            
            socket.emit('start-match-simulation', { 
                matchId: matchId,
                isExhibition: isExhibition
            });
        }

        function pauseMatch() {
            if (!socket || !isConnected) {
                addEvent('error', 'Not connected to server');
                return;
            }
            
            socket.emit('pause-match', { matchId: matchId });
        }

        function resumeMatch() {
            if (!socket || !isConnected) {
                addEvent('error', 'Not connected to server');
                return;
            }
            
            socket.emit('resume-match', { matchId: matchId });
        }

        function updateMatchState(state) {
            if (!state) return;
            
            // Update scores
            document.getElementById('homeScore').textContent = state.homeScore || 0;
            document.getElementById('awayScore').textContent = state.awayScore || 0;
            
            // Update game time
            const minutes = Math.floor((state.gameTime || 0) / 60);
            const seconds = (state.gameTime || 0) % 60;
            const maxMinutes = Math.floor((state.maxTime || 1800) / 60);
            const timeText = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')} / ${maxMinutes}:00`;
            document.getElementById('gameTime').textContent = timeText;
            
            // Update match type
            const matchType = (state.maxTime || 1800) > 1800 ? 'League Match (40min)' : 'Exhibition Match (30min)';
            document.getElementById('matchType').textContent = matchType;
        }

        function addEvent(type, description, eventData = null) {
            const eventsDiv = document.getElementById('events');
            const eventElement = document.createElement('div');
            
            let className = 'event';
            if (type === 'score') className += ' score-event';
            else if (type === 'tackle') className += ' tackle-event';
            else if (type === 'pass') className += ' pass-event';
            else if (type === 'block') className += ' block-event';
            
            eventElement.className = className;
            
            const timestamp = new Date().toLocaleTimeString();
            let eventText = `[${timestamp}] ${description}`;
            
            if (eventData && eventData.stats) {
                eventText += ` (Score: ${eventData.stats.newScore?.home || 0} - ${eventData.stats.newScore?.away || 0})`;
            }
            
            eventElement.textContent = eventText;
            eventsDiv.insertBefore(eventElement, eventsDiv.firstChild);
            
            // Keep only last 50 events
            while (eventsDiv.children.length > 50) {
                eventsDiv.removeChild(eventsDiv.lastChild);
            }
        }

        function clearEvents() {
            document.getElementById('events').innerHTML = '';
        }

        function checkServerStatus() {
            fetch('/api/realtime-status')
                .then(response => response.json())
                .then(data => {
                    const statusInfo = document.getElementById('statusInfo');
                    statusInfo.innerHTML = `
                        <div><strong>Status:</strong> ${data.status}</div>
                        <div><strong>Connected Users:</strong> ${data.connectedUsers}</div>
                        <div><strong>Active Matches:</strong> ${data.activeMatches?.length || 0}</div>
                        <div><strong>Step:</strong> ${data.step}</div>
                        <div><strong>Last Update:</strong> ${data.timestamp}</div>
                    `;
                })
                .catch(error => {
                    const statusInfo = document.getElementById('statusInfo');
                    statusInfo.innerHTML = `<div style="color: #f44336;">Error: ${error.message}</div>`;
                });
        }

        // Send heartbeat every 30 seconds
        setInterval(() => {
            if (socket && isConnected) {
                socket.emit('heartbeat');
            }
        }, 30000);

        // Auto-connect on page load
        setTimeout(connect, 1000);
    </script>
</body>
</html>